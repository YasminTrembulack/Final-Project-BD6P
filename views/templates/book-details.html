<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/logo.svg') }}">
    <title>Detalhes do Livro | LitScore</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/book-details.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/forms.css') }}" />
</head>

<body>
    {% with messages = get_flashed_messages(with_categories=True) %}
    {% if messages %}
    <div id="flash-messages" class="header-space">
        {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- HEADER -->
    <header class="header">
        <div class="logo">
            <img src="../static/images/logo.svg" alt="LitScore Logo" class="logo-img" />
            <span>LitScore</span>
        </div>
        <nav class="nav">
            <a href="{{ url_for('index') }}">Sobre nós</a>
            <a href="{{ url_for('get_books') }}">Livros</a>
            <a href="{{ url_for('contact') }}">Contato</a>
            {% if logged_user and logged_user.role == 'admin'%}
            <a href="{{ url_for('get_users') }}">Usuários</a>
            {% endif %}

            <!-- MENU DE PERFIL -->
            {% if logged_user %}
            <div class="profile-menu" id="profileMenu">
                <div class="profile-info" id="profileTrigger">
                    <div class="profile-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="22" height="22">
                            <path
                                d="M12 12c2.67 0 8 1.34 8 4v4H4v-4c0-2.66 5.33-4 8-4zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />
                        </svg>
                    </div>
                    <span class="username">{{ logged_user.username }}</span>
                    <svg class="arrow-down" xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"
                        width="18" height="18">
                        <path d="M7 10l5 5 5-5H7z" />
                    </svg>
                </div>

                <ul class="profile-dropdown" id="profileDropdown">
                    <li><a href="{{ url_for('get_user', user_id=logged_user.id) }}">Meu perfil</a></li>
                    
                    <li><a href="{{ url_for('logout') }}">Sair</a></li>
                </ul>
            </div>
            {% else %}
            <a href="{{ url_for('login') }}" class="btn-login">Entrar</a>
            {% endif %}
        </nav>
    </header>

    <!-- DETALHES DO LIVRO -->
    {% if logged_user %}
    <section class="book-details">
        <div class="book-cover">
            {% if book.img_link and book.img_link.startswith('cover_uploads/')%}
            <img src="{{ url_for('static', filename=book.img_link ) }}   " alt="Capa do Livro">
            {% elif book.img_link %}
            <img src="{{ book.img_link }}" alt="Capa do Livro">
            {% else %}
            <img src="{{ 'https://plus.unsplash.com/premium_photo-1675738775295-dffbbd2e6f34?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&q=80&w=687' }}"
                alt="Capa do Livro">
            {% endif %}
        </div>
        <div class="book-info">
            <h1>{{ book.title }}</h1>
            <p class="author">{{ book.author }}</p>
            <p class="genre"><strong>Gênero:</strong> {{ book.category }}</p>
            <p class="upc"><strong>Código UPC:</strong> {{ book.upc.upper() }}</p>
            <p class="description"> {{ book.description }}</p>
            <div class="book-actions">

                <a class="download-btn" href="{{ url_for('download_sample', book_id=book.id) }}" download>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="white">
                        <path d="M5 20h14v-2H5v2zm7-18v12l4-4h-3V2h-2v8H8l4 4z"/>
                    </svg>
                    Baixar Prévia
                </a>
                <a href="{{ url_for('create_review', book_id=book.id) }}" class="review-btn">Avaliar</a>

            </div>

            <div class="reviews-section">
                <h2>Comentários</h2>
                {% if reviews %}
                {% for review in reviews %}
                <div class="review">
                    <div class="review-header">
                        <div class="author-section">
                            <span class="review-author">{{ review.user.username }}</span>
                            <div class="review-stars">
                                {% for i in range(1, 6) %}
                                <span class="star {% if i <= review.rating %}filled{% endif %}">★</span>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="review-controls">
                            {% if logged_user and logged_user.id == review.user_id %}
                            <a href="{{ url_for('update_review', review_id=review.id )}}"
                                class="edit-review">Editar</a>
                            {% endif %}
                            {% if logged_user and logged_user.role == 'admin' or logged_user.id == review.user_id %}
                            <a href="{{ url_for('delete_review', review_id=review.id, book_id=book.id )}}"
                                class="delete-review">Deletar</a>
                            {% endif %}
                            <span class="review-date">{{ review.created_at.strftime('%d/%m/%Y %H:%M')}}</span>
                        </div>

                    </div>
                    <p class="review-text">{{ review.comment }}</p>
                </div>
                {% endfor %}
                {% else %}
                <p>Nenhum comentário ainda.</p>
                {% endif %}
            </div>
    </section>

    {% else %}
    <div class="empty-page">
        <div class="login-box">
            <h2>Você precisa estar logado</h2>
            <p>Entre na sua conta para visualizar os detalhes do livro, favoritar e deixar um comentário.</p>
            <div class="login-actions">
                <a href="{{ url_for('login') }}" class="btn-login">Entrar</a>
                <a href="{{ url_for('create_user') }}" class="btn-register">Criar conta</a>
            </div>
        </div>
    </div>
    {% endif %}



    <footer class="footer">
        <p>© 2025 LitScore — Todos os direitos reservados.</p>
    </footer>

    <script src="{{ url_for('static', filename='js/profile-dropdown.js') }}"></script>
    <script src="{{ url_for('static', filename='js/flash-message.js') }}"></script>
    <script src="{{ url_for('static', filename='js/star-rating.js') }}"></script>

</body>

</html>