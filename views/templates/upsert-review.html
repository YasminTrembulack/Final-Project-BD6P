<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% if book_to_update %}Editar Review | LitScore{% else %}Adicionar Review | LitScore{% endif %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/forms.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/upsert-review.css') }}" />
</head>

<body>
    {% with messages = get_flashed_messages(with_categories=True) %}
    {% if messages %}
    <div id="flash-messages" class="header-space">
        {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- HEADER -->
    <header class="header">
        <div class="logo">
            <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="LitScore Logo" class="logo-img" />
            <span>LitScore</span>
        </div>
        <nav class="nav">
            <a href="{{ url_for('index') }}">Sobre nós</a>
            <a href="{{ url_for('get_books') }}">Livros</a>
            <a href="{{ url_for('contact') }}">Contato</a>
            {% if logged_user and logged_user.role == 'admin'%}
            <a href="{{ url_for('get_users') }}">Usuários</a>
            {% endif %}

            <!-- MENU DE PERFIL -->
            {% if logged_user %}
            <div class="profile-menu" id="profileMenu">
                <div class="profile-info" id="profileTrigger">
                    <div class="profile-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="22" height="22">
                            <path
                                d="M12 12c2.67 0 8 1.34 8 4v4H4v-4c0-2.66 5.33-4 8-4zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />
                        </svg>
                    </div>
                    <span class="username">{{ logged_user.username }}</span>
                    <svg class="arrow-down" xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"
                        width="18" height="18">
                        <path d="M7 10l5 5 5-5H7z" />
                    </svg>
                </div>

                <ul class="profile-dropdown" id="profileDropdown">
                    <li><a href="{{ url_for('get_user', user_id=logged_user.id) }}">Meu perfil</a></li>
                    
                    <li><a href="{{ url_for('logout') }}">Sair</a></li>
                </ul>
            </div>
            {% else %}
            <a href="{{ url_for('login') }}" class="btn-login">Entrar</a>
            {% endif %}
        </nav>
    </header>

    <!-- DETALHES DO LIVRO -->
    {% if logged_user %}

    <!-- MODAL -->
    <div class="review">
        <div class="form-content comment-form">
            <h2>{% if review_to_update %}Atualizar Comentário{% else %}Adicionar Comentário{% endif %}</h2>
            <p class="form-subtitle">
                {% if book_to_update %}
                Atualize as informações do comentário abaixo.
                {% else %}
                Compartilhe sua opinião sobre este livro.
                {% endif %}
            </p>

            <form
                action="{% if review_to_update %}{{ url_for('update_review', review_id=review_to_update.id) }}{% else %}{{ url_for('create_review', book_id=book_id) }}{% endif %}"
                method="POST">
                <!-- Avaliação em estrelas -->

                <input type="hidden" name="rating" id="ratingValue"
                    value="{% if review_to_update %}{{ review_to_update.rating }}{% else %}1{% endif %}">

                <input type="hidden" name="book_id" value="{% if review_to_update %}{{ book_id }}{% endif %}">

                <div class="input-group">
                    <label>Avaliação</label>
                    <div class="star-rating">
                        {% if review_to_update %}
                        {% for i in range(1, 6) %}
                        <span class="star {% if i <= review_to_update.rating %}filled{% endif %}"
                            data-value="{{ i }}">★</span>
                        {% endfor %}
                        {% else %}
                        {% for i in range(1, 6) %}
                        <span class="star {% if i == 1 %}filled{% endif %}" data-value="{{ i }}">★</span>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <!-- Comentário -->
                <div class="input-group">
                    <label for="reviewText">Comentário</label>
                    <textarea id="reviewText" name="comment" rows="5" placeholder="Escreva seu comentário..."
                        required>{{ review_to_update.comment if review_to_update else '' }}</textarea>
                </div>

                <button type="submit">{% if review_to_update %}Salvar Alterações{% else %}Enviar Comentário{% endif %}</button>
            </form>

        </div>
    </div>

    {% else %}

    <div class="empty-page">
        <div class="login-box">
            <h2>Você precisa estar logado</h2>
            <p>Entre na sua conta para editar ou criar comentário.</p>
            <div class="login-actions">
                <a href="{{ url_for('login') }}" class="btn-login">Entrar</a>
                <a href="{{ url_for('create_user') }}" class="btn-register">Criar conta</a>
            </div>
        </div>
    </div>

    {% endif %}

    <footer class="footer">
        <p>© 2025 LitScore — Todos os direitos reservados.</p>
    </footer>

    <script src="{{ url_for('static', filename='js/profile-dropdown.js') }}"></script>
    <script src="{{ url_for('static', filename='js/flash-message.js') }}"></script>
    <script src="{{ url_for('static', filename='js/star-rating.js') }}"></script>

</body>

</html>